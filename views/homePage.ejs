<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>By A Thread - Home</title>
    <!-- Bootstrap CSS (Optional) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="homePage.css" />
</head>

<body>
    <!-- Navigation Bar -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
              <img src="/ByAThread.webp" alt="Logo" style="height: 40px; margin-right: 10px;" /> <!-- Adjust height as necessary -->
              By A Thread
            </a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                  aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav ms-auto">
                      <li class="nav-item">
                          <a class="nav-link active" aria-current="page" href="/homePage">Home</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="/">Landing Page</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#">About</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="redirectToLoginIfNotLoggedIn()">Cart</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="redirectToLoginIfNotLoggedIn()">Profile</a>
                      </li>

                      <!-- Show "Login" if not logged in, otherwise show "Logout" -->
                      <% if (!username) { %>
                      <li class="nav-item">
                          <a class="nav-link" href="/login">Login</a>
                      </li>
                      <% } else { %>
                      <li class="nav-item">
                          <a class="nav-link" href="javascript:void(0);" onclick="handleLogout()">Logout</a>
                      </li>
                      <% } %>
                      
                      <% if (isAdmin) { %>
                      <li class="nav-item">
                          <a class="nav-link" onclick="renderAdminPage()">Admin tools</a>
                      </li>
                      <% } %>
                  </ul>
              </div>
          </div>
      </nav>
  </header>

    <!-- Title -->
    <div class="container text-center mt-5">
        <h1 class="text-center">Welcome <%= username %>!</h1>
    </div>

    <!-- Weather and Filter Section -->
    <aside class="container mt-4">
        <div class="row align-items-stretch">
            <!-- Weather Widget Column -->
            <div class="col-md-3 d-flex">
                <div id="weatherWidget" class="p-3 bg-light rounded flex-fill">
                    <h4>Current Weather</h4>
                    <p id="weatherLocation">Location: Fetching...</p>
                    <p id="weatherTemp">Temperature: Fetching...</p>
                    <p id="weatherCondition">Condition: Fetching...</p>
                </div>
            </div>

            <!-- Filter Section Column -->
            <div class="col-md-9 d-flex">
                <form id="filterForm" class="row g-3 bg-light rounded p-3 flex-fill" action="/homePage" method="GET">
                    <!-- Name Filter -->
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="filterName" name="name"
                            placeholder="Filter by Name" value="<%= filters.name %>" />
                    </div>
                    <!-- Price Condition -->
                    <div class="col-md-2">
                        <select class="form-control" id="priceCondition" name="priceCondition"
                            onchange="updatePricePlaceholder()">
                            <option value="equal" <%= filters.priceCondition === 'equal' ? 'selected' : '' %>>Equal
                                to</option>
                            <option value="greater" <%= filters.priceCondition === 'greater' ? 'selected' : '' %>>
                                Greater than</option>
                            <option value="less" <%= filters.priceCondition === 'less' ? 'selected' : '' %>>Less
                                than</option>
                            <option value="between" <%= filters.priceCondition === 'between' ? 'selected' : '' %>>
                                Between</option>
                        </select>
                    </div>
                    <!-- Price Filter -->
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="filterPrice" name="price" placeholder="Price"
                            value="<%= typeof filters.price !== 'undefined' ? filters.price : '' %>" />
                    </div>
                    <!-- Max Price (for 'Between' condition) -->
                    <div class="col-md-2" id="priceRange"
                        style="<%= filters.priceCondition === 'between' ? 'display: block;' : 'display: none;' %>">
                        <input type="number" class="form-control" id="filterPriceMax" name="priceMax"
                            placeholder="Max Price" value="<%= typeof filters.priceMax !== 'undefined' ? filters.priceMax : '' %>" />
                    </div>
                    <!-- Category Filter -->
                    <div class="col-md-2">
                        <select class="form-select" id="filterCategory" name="category">
                            <option value="">All Categories</option>
                            <option value="Tops" <%= filters.category === 'Tops' ? 'selected' : '' %>>Tops</option>
                            <option value="Bottoms" <%= filters.category === 'Bottoms' ? 'selected' : '' %>>Bottoms
                            </option>
                            <option value="Outerwear" <%= filters.category === 'Outerwear' ? 'selected' : '' %>>Outerwear
                            </option>
                            <option value="Dresses" <%= filters.category === 'Dresses' ? 'selected' : '' %>>Dresses
                            </option>
                            <option value="Footwear" <%= filters.category === 'Footwear' ? 'selected' : '' %>>Footwear
                            </option>
                            <option value="Accessories" <%= filters.category === 'Accessories' ? 'selected' : '' %>>
                                Accessories</option>
                        </select>
                    </div>
                    <!-- Gender Filter -->
                    <div class="col-md-2">
                        <select class="form-select" id="filterGender" name="gender">
                            <option value="">All Genders</option>
                            <option value="male" <%= filters.gender === 'male' ? 'selected' : '' %>>Male</option>
                            <option value="female" <%= filters.gender === 'female' ? 'selected' : '' %>>Female</option>
                            <option value="unisex" <%= filters.gender === 'unisex' ? 'selected' : '' %>>Unisex</option>
                        </select>
                    </div>
                    <!-- Non Sold Out Filter -->
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterNonSoldOut" name="nonSoldOut"
                                value="true" <%= filters.nonSoldOut ? 'checked' : '' %>>
                            <label class="form-check-label" for="filterNonSoldOut">
                                Non Sold Out
                            </label>
                        </div>
                    </div>
                    <!-- Filter Button -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                    </div>
                    <!-- Reset Button -->
                    <div class="col-md-2">
                        <button type="button" class="btn btn-secondary w-100" onclick="resetFilters()">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </aside>

    <!-- Sliding Gallery -->
    <section class="container mt-5">
        <div id="productCarousel" class="carousel slide mx-auto" data-bs-ride="carousel" data-bs-interval="5000"
            style="max-width: 600px;">
            <div class="carousel-inner">
                <% if (UnFilteredProducts.length > 1) { %>
                <% UnFilteredProducts.forEach((product, index) => { %>
                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <a href="#">
                        <div class="carousel-image-container">
                            <img src="data:image/<%= product.imageType %>;base64,<%= product.image.toString('base64') %>"
                                class="d-block w-100" alt="<%= product.name %>"
                                style="object-fit: cover; height: 300px; border-radius: 10px;">
                            <% if (product.amount === 0) { %>
                            <div class="sold-out-overlay">Sold Out</div>
                            <% } %>
                        </div>
                    </a>
                </div>
                <% }) %>
                <% } else if (UnFilteredProducts.length === 1) { %>
                <div class="carousel-item active">
                    <a href="#">
                        <div class="carousel-image-container">
                            <img src="data:image/<%= products[0].imageType %>;base64,<%= products[0].image.toString('base64') %>"
                                class="d-block w-100" alt="<%= products[0].name %>"
                                style="object-fit: cover; height: 300px; border-radius: 10px;">
                            <% if (UnFilteredProducts[0].amount === 0) { %>
                            <div class="sold-out-overlay">Sold Out</div>
                            <% } %>
                        </div>
                    </a>
                </div>
                <% } %>
            </div>
            <% if (UnFilteredProducts.length > 1) { %>
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
            <% } %>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mt-5">
        <div class="row" id="itemsContainer">
            <% if (products.length === 0) { %>
            <div class="col-12 text-center">
                <h2>No items yet!</h2>
            </div>
            <% } else { %>
            <% products.forEach(product => { %>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div style="position: relative;">
                        <img src="data:image/<%= product.imageType %>;base64,<%= product.image.toString('base64') %>"
                            class="card-img-top" alt="<%= product.name %>" />
                        <% if (product.amount === 0) { %>
                        <div
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.7); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.5rem;">
                            Sold Out</div>
                        <% } %>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">
                            <%= product.name %>
                        </h5>
                        <p class="card-text">
                            <strong>Price:</strong> $
                            <%= product.price %>
                        </p>
                        <p class="card-text">
                            <strong>Category:</strong>
                            <%= product.category %>
                        </p>
                        <p class="card-text">
                            <strong>Company:</strong>
                            <%= product.company %>
                        </p>
                        <p class="card-text">
                            <strong>Gender:</strong>
                            <%= product.gender %>
                        </p>
                        <button class="btn btn-primary" onclick="handleAddToCart('<%= product.prodId %>')" <%= product.amount === 0 ? 'disabled' : '' %>>Add to Cart</button>
                    </div>
                </div>
            </div>
            <% }) %>
            <% } %>
        </div>
    </main>

    <!-- Footer -->
    <%- include('_footer') %>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script>
        // Fetch Weather Data
        function fetchWeather() {
            const apiKey = '<%= weatherApiKey %>'; // Replace with your WeatherAPI.com API key
            const url = `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=auto:ip`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('weatherLocation').textContent = `Location: ${data.location.name}, ${data.location.region}`;
                    document.getElementById('weatherTemp').textContent = `Temperature: ${data.current.temp_c}°C`;

                    // Add emoji based on weather condition
                    let emoji = '';
                    const condition = data.current.condition.text.toLowerCase();

                    if (condition.includes('sunny')) {
                        emoji = '☀️';
                    } else if (condition.includes('cloudy')) {
                        emoji = '☁️';
                    } else if (condition.includes('rain')) {
                        emoji = '🌧️';
                    } else if (condition.includes('snow')) {
                        emoji = '❄️';
                    } else if (condition.includes('thunder')) {
                        emoji = '⛈️';
                    } else if (condition.includes('fog')) {
                        emoji = '🌫️';
                    } else if (condition.includes('clear')) {
                        emoji = '🌕';
                    } else if (condition.includes('wind')) {
                        emoji = '🌬️';
                    } else {
                        emoji = '🌡️'; // Default emoji for other conditions
                    }

                    document.getElementById('weatherCondition').textContent = `Condition: ${data.current.condition.text} ${emoji}`;
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                });
        }

        // Call fetchWeather function on page load
        document.addEventListener('DOMContentLoaded', fetchWeather);

        // Logout function
        function handleLogout() {
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin'
            })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url; // Redirect to the login page
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                    alert('An error occurred while logging out.');
                });
        }

        // Redirect to login if not logged in
        function redirectToLoginIfNotLoggedIn() {
            <% if (!username) { %>
                window.location.href = "/login";
            <% } %>
        }

        function renderAdminPage() {
            window.location.href = "/admin"; // Redirects the user to the /admin page
        }

        function redirectToCart() {
            <% if (!username) { %>
                window.location.href = '/login'; // Redirect to login if not authenticated
            <% } else { %>
                window.location.href = '/cart'; // Redirect to the cart page if logged in
            <% } %>
        }

        function redirectToProfile() {
            <% if (!username) { %>
                window.location.href = '/login'; // Redirect to login if not authenticated
            <% } else { %>
                window.location.href = '/profile'; // Redirect to the profile page if logged in
            <% } %>
        }

        function updatePricePlaceholder() {
            const priceCondition = document.getElementById("priceCondition").value;
            const filterPrice = document.getElementById("filterPrice");
            const priceRange = document.getElementById("priceRange");

            if (priceCondition === "equal") {
                filterPrice.placeholder = "Price";
                priceRange.style.display = "none";
            } else if (priceCondition === "greater") {
                filterPrice.placeholder = "Greater than";
                priceRange.style.display = "none";
            } else if (priceCondition === "less") {
                filterPrice.placeholder = "Less than";
                priceRange.style.display = "none";
            } else if (priceCondition === "between") {
                filterPrice.placeholder = "Min Price";
                priceRange.style.display = "block";
            }
        }

        function resetFilters() {
            window.location.href = "/homePage"; // Reset filters and redirect to homepage
        }

        function handleAddToCart(prodId) {
            <% if (!username) { %>
                window.location.href = '/login'; // Redirect to login if not authenticated
            <% } else { %>
                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userName: '<%= username %>', prodId: prodId }),
                })
                .then(response => response.json())  // Expecting JSON response
                .then(data => {
                    alert(data.message); // Show a success message to the user
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    alert('Error adding to cart');
                });
            <% } %>
        }

    </script>
</body>

</html>
